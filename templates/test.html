<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poetry Generator</title>
  <style>
    .quote-container {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    .quote {
      padding: 10px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      cursor: move;
      user-select: none;
    }
    #canvas {
      border: 1px solid black;
      margin-top: 20px;
      position: relative;
    }
    .quote-dragging {
      opacity: 0.5;
    }
  </style>
</head>
<body>
    <div class="row" id="back-button">
        <p onclick="window.location.href='/fragments'">Review instructions</p>
    </div>
    
    <div class="row">
        <div class="quotes-container col-6">
            <!-- search box -->
            <form onsubmit="event.preventDefault(); submitSearch(document.getElementById('search-query').value);">
                <input type="search" id="search-query" name="query" placeholder="Search keywords..." aria-label="Search">
                <!-- <button type="submit">Search</button> -->
            </form>

            <!-- filter buttons -->
            <div class="filter-buttons">
                <button class="button-small" onclick="submitSearch('Nature')">Nature</button>
                <button class="button-small" onclick="submitSearch('Sensuality')">Sensuality</button>
                <button class="button-small" onclick="submitSearch('Love')">Love</button>
                <button class="button-small" onclick="submitSearch('Life')">Life</button>
                <button class="button-small" onclick="submitSearch('Divinity')">Divinity</button>
            </div>

            <!-- quotes -->
            <div id="results">
                <div class="quote-container" id="quotes-container">
                    {% for quote in results %}
                        <div class="quote" id="quote{{ loop.index }}" draggable="true">{{ quote.quote }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    
        <div class="canvas-container col-6">
            <h2>Drag and Drop Your Elements Here</h2>
            <canvas id="canvas" width="500" height="300"></canvas>

            <div id="download">
                <button onclick="downloadImage()">Save and Share</button>
            </div>
        </div>
    </div>

  <script>
    function submitSearch(query) {
        const form = document.createElement('form');
        form.action = '/create';
        form.method = 'get';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'query';
        input.value = query;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
    // Array to store quote positions
    const quotePositions = [];

    // Function to handle drag start
    document.querySelectorAll('.quote').forEach((quote) => {
      quote.addEventListener('dragstart', (event) => {
        event.dataTransfer.setData('text/plain', event.target.id);
        event.target.classList.add('quote-dragging');
      });

      quote.addEventListener('dragend', (event) => {
        event.target.classList.remove('quote-dragging');
      });
    });

    // Function to handle drop onto the canvas
    const canvas = document.getElementById('canvas');
    canvas.addEventListener('dragover', (event) => {
      event.preventDefault();
    });

    canvas.addEventListener('drop', (event) => {
      event.preventDefault();
      const quoteId = event.dataTransfer.getData('text/plain');
      const quote = document.getElementById(quoteId);
      const canvasRect = canvas.getBoundingClientRect();

      // Get mouse position relative to canvas
      const mouseX = event.clientX - canvasRect.left;
      const mouseY = event.clientY - canvasRect.top;

      // Store the dropped position of the quote
      quotePositions.push({ quoteId, x: mouseX, y: mouseY });

      drawCanvas();
    });

    // Function to draw the quotes on the canvas
    function drawCanvas() {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas

      quotePositions.forEach(({ quoteId, x, y }) => {
        const quoteText = document.getElementById(quoteId).textContent;
        ctx.font = '20px Arial';
        ctx.fillStyle = 'black';
        ctx.fillText(quoteText, x, y); // Draw the quote text at the stored position
      });
    }

    // Function to download the canvas content as an image
    function downloadImage() {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas for the final render

      // Draw all quotes at their stored positions
      quotePositions.forEach(({ quoteId, x, y }) => {
        const quoteText = document.getElementById(quoteId).textContent;
        ctx.font = '20px Arial';
        ctx.fillStyle = 'black';
        ctx.fillText(quoteText, x, y); // Draw the quote text at the stored position
      });

      // Create a download link for the canvas as an image
      const link = document.createElement('a');
      link.download = 'my_poem.png';
      link.href = canvas.toDataURL('image/png'); // Convert the canvas to a data URL
      link.click(); // Trigger the download
    }
  </script>
</body>
</html>
